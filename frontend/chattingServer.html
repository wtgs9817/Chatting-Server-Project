<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #chat-box { width: 500px; height: 400px; border: 1px solid black; overflow-y: auto; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9; }
        #message-input { width: 400px; padding: 5px; }
        .system-msg { color: gray; font-style: italic; margin: 5px 0; }
        .chat-msg { margin: 5px 0; }
    </style>
</head>
<body>
<h2>채팅방</h2>
<div id="chat-box"></div>
<input type="text" id="message-input" placeholder="메시지 입력">
<button onclick="send()">전송</button>
<button onclick="disconnect()">나가기</button>

<script>
    let stompClient = null;
    let myNickname = null;
    let currentRoomId = null;

    // 1. 페이지 로드 시 닉네임 입력
    window.onload = function() {
        myNickname = prompt("닉네임을 입력하세요:");
        if (!myNickname) {
            myNickname = "익명" + Math.floor(Math.random() * 1000);
        }
        connect();
    };

    function connect() {
        // 백엔드 엔드포인트와 연결 (setAllowedOriginPatterns("*") 설정 필수)
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);

            // A. [개인 채널] 방 입장 정보를 받기 위한 구독
            stompClient.subscribe('/user/queue/room-info', function(response) {
                currentRoomId = response.body;
                console.log('입장한 방 번호: ' + currentRoomId);

                // [해결] 구독 완료 전 방송되는 입장 메시지 유실을 방지하기 위해 본인 화면에 즉시 표시
                addSystemMessage(myNickname + "님이 입장했습니다.");

                // B. [공용 채널] 채팅방 메시지 및 타인 입장 알림 구독
                stompClient.subscribe('/topic/chatroom/' + currentRoomId, function(message) {
                    const data = JSON.parse(message.body);

                    // 본인의 입장 알림 DTO가 중복으로 올 경우 무시
                    if (data.userId === myNickname && !data.content) {
                        return;
                    }

                    // content가 없으면 입장 알림, 있으면 채팅 메시지
                    if (!data.content) {
                        addSystemMessage(data.userId + "님이 입장했습니다.");
                    } else {
                        displayMessage(data);
                    }
                });
            });

            // C. 서버에 입장 요청 전송 (RequestDTO에 맞춰 userId 전송)
            stompClient.send('/app/chat.join', {}, JSON.stringify({ userId: myNickname }));
        });
    }

    function send() {
        const content = document.getElementById('message-input').value;
        if (!content || !currentRoomId) return;

        // 서버의 @MessageMapping("/chat.send/{roomId}") 주소로 전송
        // MessageDTO의 필드명(userId, content)과 일치시켜야 함
        stompClient.send('/app/chat.send/' + currentRoomId, {}, JSON.stringify({
            userId: myNickname,
            content: content
        }));

        document.getElementById('message-input').value = '';
    }

    function displayMessage(data) {
        const chatBox = document.getElementById('chat-box');
        // 서버 DTO 필드명이 userId이므로 data.userId로 접근 (undefined 해결)
        const sender = data.userId || "알 수 없음";
        chatBox.innerHTML += `<div class="chat-msg"><b>${sender}:</b> ${data.content}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addSystemMessage(text) {
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML += `<div class="system-msg">${text}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            addSystemMessage("연결이 종료되었습니다.");
        }
    }

    // 엔터키 전송 이벤트
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') send();
    });
</script>
</body>
</html>